// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: jobs.sql

package sqlitedb

import (
	"context"
)

const claimNextJob = `-- name: ClaimNextJob :one
UPDATE jobs SET
    status = 'running',
    started_at = datetime('now'),
    attempts = attempts + 1
WHERE id = (
    SELECT id FROM jobs
    WHERE status = 'pending'
    ORDER BY created_at ASC
    LIMIT 1
)
RETURNING id, media_id, type, status, error_message, attempts, created_at, started_at, completed_at, codec, fps
`

func (q *Queries) ClaimNextJob(ctx context.Context) (Job, error) {
	row := q.db.QueryRowContext(ctx, claimNextJob)
	var i Job
	err := row.Scan(
		&i.ID,
		&i.MediaID,
		&i.Type,
		&i.Status,
		&i.ErrorMessage,
		&i.Attempts,
		&i.CreatedAt,
		&i.StartedAt,
		&i.CompletedAt,
		&i.Codec,
		&i.Fps,
	)
	return i, err
}

const completeJob = `-- name: CompleteJob :exec
UPDATE jobs SET
    status = 'done',
    completed_at = datetime('now')
WHERE id = ?
`

func (q *Queries) CompleteJob(ctx context.Context, id int64) error {
	_, err := q.db.ExecContext(ctx, completeJob, id)
	return err
}

const failJob = `-- name: FailJob :exec
UPDATE jobs SET
    status = 'failed',
    error_message = ?,
    completed_at = datetime('now')
WHERE id = ?
`

type FailJobParams struct {
	ErrorMessage string
	ID           int64
}

func (q *Queries) FailJob(ctx context.Context, arg FailJobParams) error {
	_, err := q.db.ExecContext(ctx, failJob, arg.ErrorMessage, arg.ID)
	return err
}

const getJob = `-- name: GetJob :one
SELECT id, media_id, type, status, error_message, attempts, created_at, started_at, completed_at, codec, fps FROM jobs WHERE id = ? LIMIT 1
`

func (q *Queries) GetJob(ctx context.Context, id int64) (Job, error) {
	row := q.db.QueryRowContext(ctx, getJob, id)
	var i Job
	err := row.Scan(
		&i.ID,
		&i.MediaID,
		&i.Type,
		&i.Status,
		&i.ErrorMessage,
		&i.Attempts,
		&i.CreatedAt,
		&i.StartedAt,
		&i.CompletedAt,
		&i.Codec,
		&i.Fps,
	)
	return i, err
}

const insertJob = `-- name: InsertJob :one
INSERT INTO jobs (media_id, type, codec, fps, status, created_at)
VALUES (?, ?, ?, ?, 'pending', datetime('now'))
RETURNING id, media_id, type, status, error_message, attempts, created_at, started_at, completed_at, codec, fps
`

type InsertJobParams struct {
	MediaID string
	Type    string
	Codec   string
	Fps     int64
}

func (q *Queries) InsertJob(ctx context.Context, arg InsertJobParams) (Job, error) {
	row := q.db.QueryRowContext(ctx, insertJob,
		arg.MediaID,
		arg.Type,
		arg.Codec,
		arg.Fps,
	)
	var i Job
	err := row.Scan(
		&i.ID,
		&i.MediaID,
		&i.Type,
		&i.Status,
		&i.ErrorMessage,
		&i.Attempts,
		&i.CreatedAt,
		&i.StartedAt,
		&i.CompletedAt,
		&i.Codec,
		&i.Fps,
	)
	return i, err
}

const listJobsByMedia = `-- name: ListJobsByMedia :many
SELECT id, media_id, type, status, error_message, attempts, created_at, started_at, completed_at, codec, fps FROM jobs WHERE media_id = ? ORDER BY created_at ASC
`

func (q *Queries) ListJobsByMedia(ctx context.Context, mediaID string) ([]Job, error) {
	rows, err := q.db.QueryContext(ctx, listJobsByMedia, mediaID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []Job
	for rows.Next() {
		var i Job
		if err := rows.Scan(
			&i.ID,
			&i.MediaID,
			&i.Type,
			&i.Status,
			&i.ErrorMessage,
			&i.Attempts,
			&i.CreatedAt,
			&i.StartedAt,
			&i.CompletedAt,
			&i.Codec,
			&i.Fps,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listPendingJobs = `-- name: ListPendingJobs :many
SELECT id, media_id, type, status, error_message, attempts, created_at, started_at, completed_at, codec, fps FROM jobs WHERE status = 'pending' ORDER BY created_at ASC
`

func (q *Queries) ListPendingJobs(ctx context.Context) ([]Job, error) {
	rows, err := q.db.QueryContext(ctx, listPendingJobs)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []Job
	for rows.Next() {
		var i Job
		if err := rows.Scan(
			&i.ID,
			&i.MediaID,
			&i.Type,
			&i.Status,
			&i.ErrorMessage,
			&i.Attempts,
			&i.CreatedAt,
			&i.StartedAt,
			&i.CompletedAt,
			&i.Codec,
			&i.Fps,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const resetStalledJobs = `-- name: ResetStalledJobs :exec
UPDATE jobs SET
    status = 'pending',
    started_at = NULL
WHERE status = 'running'
`

func (q *Queries) ResetStalledJobs(ctx context.Context) error {
	_, err := q.db.ExecContext(ctx, resetStalledJobs)
	return err
}
